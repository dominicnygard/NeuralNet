#include <catch2/catch_all.hpp>
#include "ConvLayer.h"

// =============================================================================
// Convolution layer Forward Tests
// =============================================================================

inline bool approx_equal(float a, float b, float epsilon = 1e-5f) {
    return std::abs(a - b) < epsilon;
}

inline Tensor<float, 4> createWeights(int output_channels, int input_channels, int kernel_h, int kernel_w) {
    const int total = output_channels * input_channels * kernel_h * kernel_w;
    Tensor<float, 4> weights(output_channels, input_channels, kernel_h, kernel_w);
    int idx = 0;
    for (int o = 0; o < output_channels; o++) {
        for (int c = 0; c <input_channels; c++) {
            for (int kh = 0; kh < kernel_h; kh++) {
                for (int kw = 0; kw < kernel_w; kw++) {
                    float v = (idx / float(total - 1)) - 0.5f; // in [-0.5, 0.5]
                    weights(o, c, kh, kw) = v;
                    idx++;
                }
            }
        }
    }
    return weights;
}

TEST_CASE("Normal forward convolution with set kernel and bias", "[convolution][forward]") {

    int batches = 2;
    int in_channels = 3;
    int out_channels = 8;
    int in_h = 10;
    int in_w = 10;

    Tensor<float, 4> input(batches, in_channels, in_h, in_w);
    for (int n = batches; n < 2; ++n) {
        for (int h = 0; h < in_h; ++h) {
            for (int w = 0; w < in_w; ++w) {
                input(n, 0, h, w) = 5.0f;
                input(n, 1, h, w) = static_cast<float>(n * 4 + h * 2 + w);
                input(n, 2, h, w) = 1.0f;
            }
        }
    }

    Tensor<float, 1> bias(8);
    bias.setValues({0.4f, 0.2f, 0.5f, 0.5f, 0.2f, 0.9f, 0.7f, 0.5f});
    Tensor<float, 4> weights = createWeights(out_channels, in_channels, 3, 3);

    Tensor<float, 4> expectedOutput(batches, out_channels, 10, 10);
    expectedOutput.setValues({
    {
        {
        {-13.14418507, -21.30697823, -23.90232658, -26.49767494, -29.09302330, -31.68837357, -34.28372192, -36.87907028, -39.47442245, -27.19999886 },
        {-22.78372002, -36.51395416, -40.46976852, -44.42557907, -48.38138962, -52.33720398, -56.29302216, -60.24884033, -64.20465088, -44.23022842 },
        {-28.03023338, -44.42557907, -48.38138962, -52.33720398, -56.29302216, -60.24884033, -64.20465088, -68.16046143, -72.11627960, -49.53255081 },
        {-33.27674484, -52.33720398, -56.29302216, -60.24884033, -64.20465088, -68.16046143, -72.11627960, -76.07209778, -80.02790070, -54.83488083 },
        {-38.52325821, -60.24884033, -64.20465088, -68.16046143, -72.11627960, -76.07209778, -80.02790070, -83.98372650, -87.93953705, -60.13721085 },
        {-43.76976395, -68.16046143, -72.11627960, -76.07209778, -80.02790070, -83.98372650, -87.93953705, -91.89534760, -95.85116577, -65.43952942 },
        {-49.01627731, -76.07209778, -80.02790070, -83.98372650, -87.93953705, -91.89534760, -95.85116577, -99.80698395, -103.76279449, -70.74185944 },
        {-54.26279068, -83.98372650, -87.93953705, -91.89534760, -95.85116577, -99.80698395, -103.76279449, -107.71861267, -111.67441559, -76.04418182 },
        {-59.50930023, -91.89534760, -95.85116577, -99.80698395, -103.76279449, -107.71861267, -111.67441559, -115.63023376, -119.58605194, -81.34651184 },
        {-41.99069595, -64.84185791, -67.52092743, -70.19999695, -72.87906647, -75.55813599, -78.23720551, -80.91627502, -83.59535217, -56.79069519 }
        },
        {
        {-9.57674408, -15.47906971, -17.32093048, -19.16279030, -21.00465012, -22.84651184, -24.68837166, -26.53023148, -28.37209320, -19.61395264 },
        {-16.57906914, -26.54185867, -29.36744118, -32.19302368, -35.01860046, -37.84418106, -40.66976547, -43.49534607, -46.32092667, -31.99767113 },
        {-20.31860352, -32.19302368, -35.01860046, -37.84418106, -40.66976547, -43.49534607, -46.32092667, -49.14651489, -51.97209549, -35.79302597 },
        {-24.05813980, -37.84418106, -40.66976547, -43.49534607, -46.32092667, -49.14651489, -51.97209549, -54.79767227, -57.62325668, -39.58837128 },
        {-27.79767418, -43.49534607, -46.32092667, -49.14651489, -51.97209549, -54.79767227, -57.62325668, -60.44883728, -63.27442169, -43.38372040 },
        {-31.53721046, -49.14651489, -51.97209549, -54.79767227, -57.62325668, -60.44883728, -63.27442169, -66.10000610, -68.92557526, -47.17907333 },
        {-35.27674103, -54.79767227, -57.62325668, -60.44883728, -63.27442169, -66.10000610, -68.92557526, -71.75115967, -74.57673645, -50.97442245 },
        {-39.01628113, -60.44883728, -63.27442169, -66.10000610, -68.92557526, -71.75115967, -74.57673645, -77.40231323, -80.22789764, -54.76977158 },
        {-42.75581741, -66.10000610, -68.92557526, -71.75115967, -74.57673645, -77.40231323, -80.22789764, -83.05348206, -85.87907410, -58.56511688 },
        {-30.38604546, -46.95813751, -48.88371658, -50.80929565, -52.73488235, -54.66046524, -56.58604813, -58.51162720, -60.43720627, -41.16744614 }
        },
        {
        {-5.50930166, -9.15116215, -10.23953438, -11.32790661, -12.41627884, -13.50465012, -14.59302235, -15.68139458, -16.76976585, -11.52790642 },
        {-9.87441826, -16.06976700, -17.76511383, -19.46046448, -21.15581703, -22.85116386, -24.54651260, -26.24185944, -27.93721008, -19.26511765 },
        {-12.10697651, -19.46046448, -21.15581703, -22.85116386, -24.54651260, -26.24185944, -27.93721008, -29.63256073, -31.32790756, -21.55349159 },
        {-14.33953381, -22.85116386, -24.54651260, -26.24185944, -27.93721008, -29.63256073, -31.32790756, -33.02325821, -34.71860504, -23.84186363 },
        {-16.57209206, -26.24185944, -27.93721008, -29.63256073, -31.32790756, -33.02325821, -34.71860504, -36.41395187, -38.10930252, -26.13023186 },
        {-18.80464935, -29.63256073, -31.32790756, -33.02325821, -34.71860504, -36.41395187, -38.10930252, -39.80464554, -41.50000000, -28.41860580 },
        {-21.03720856, -33.02325821, -34.71860504, -36.41395187, -38.10930252, -39.80464554, -41.50000000, -43.19534683, -44.89069366, -30.70697594 },
        {-23.26976776, -36.41395187, -38.10930252, -39.80464554, -41.50000000, -43.19534683, -44.89069366, -46.58604431, -48.28139877, -32.99534607 },
        {-25.50232887, -39.80464554, -41.50000000, -43.19534683, -44.89069366, -46.58604431, -48.28139877, -49.97674561, -51.67209625, -35.28371811 },
        {-18.28139687, -28.57441902, -29.74651146, -30.91860580, -32.09069824, -33.26279068, -34.43488312, -35.60697937, -36.77907181, -25.04418564 }
        },
        {
        {-1.74186027, -3.12325597, -3.45813966, -3.79302335, -4.12790728, -4.46279097, -4.79767466, -5.13255787, -5.46744204, -3.74186063 },
        {-3.46976733, -5.89767408, -6.46279001, -7.02790737, -7.59302282, -8.15813923, -8.72325611, -9.28837299, -9.85348988, -6.83255816 },
        {-4.19534874, -7.02790737, -7.59302282, -8.15813923, -8.72325611, -9.28837299, -9.85348988, -10.41860676, -10.98372269, -7.61395264 },
        {-4.92092991, -8.15813923, -8.72325611, -9.28837299, -9.85348988, -10.41860676, -10.98372269, -11.54883957, -12.11395359, -8.39534950 },
        {-5.64651155, -9.28837299, -9.85348988, -10.41860676, -10.98372269, -11.54883957, -12.11395359, -12.67907238, -13.24418736, -9.17674541 },
        {-6.37209320, -10.41860676, -10.98372269, -11.54883957, -12.11395359, -12.67907238, -13.24418736, -13.80930328, -14.37442112, -9.95813942 },
        {-7.09767485, -11.54883957, -12.11395359, -12.67907238, -13.24418736, -13.80930328, -14.37442112, -14.93953514, -15.50465393, -10.73953533 },
        {-7.82325649, -12.67907238, -13.24418736, -13.80930328, -14.37442112, -14.93953514, -15.50465393, -16.06976891, -16.63488388, -11.52093029 },
        {-8.54883862, -13.80930328, -14.37442112, -14.93953514, -15.50465393, -16.06976891, -16.63488388, -17.20000076, -17.76511765, -12.30232525 },
        {-6.47674465, -10.49069786, -10.90930271, -11.32790661, -11.74651146, -12.16511631, -12.58372116, -13.00232601, -13.42092991, -9.22093010 }
        },
        {
        {1.72558141, 2.60465097, 3.02325559, 3.44186020, 3.86046529, 4.27906990, 4.69767427, 5.11627913, 5.53488398, 3.74418640 },
        {2.63488364, 3.97441864, 4.53953505, 5.10465145, 5.66976786, 6.23488379, 6.80000019, 7.36511612, 7.93023252, 5.30000019 },
        {3.41627908, 5.10465145, 5.66976786, 6.23488379, 6.80000019, 7.36511612, 7.93023252, 8.49534798, 9.06046486, 6.02558136 },
        {4.19767427, 6.23488379, 6.80000019, 7.36511612, 7.93023252, 8.49534798, 9.06046486, 9.62558079, 10.19069767, 6.75116301 },
        {4.97906971, 7.36511612, 7.93023252, 8.49534798, 9.06046486, 9.62558079, 10.19069767, 10.75581455, 11.32093048, 7.47674417 },
        {5.76046467, 8.49534798, 9.06046486, 9.62558079, 10.19069767, 10.75581455, 11.32093048, 11.88604641, 12.45116234, 8.20232582 },
        {6.54186058, 9.62558079, 10.19069767, 10.75581455, 11.32093048, 11.88604641, 12.45116234, 13.01627922, 13.58139515, 8.92790699 },
        {7.32325554, 10.75581455, 11.32093048, 11.88604641, 12.45116234, 13.01627922, 13.58139515, 14.14651108, 14.71162796, 9.65348816 },
        {8.10465145, 11.88604641, 12.45116234, 13.01627922, 13.58139515, 14.14651108, 14.71162796, 15.27674389, 15.84186077, 10.37906933 },
        {5.02790737, 7.29302311, 7.62790680, 7.96279001, 8.29767418, 8.63255787, 8.96744156, 9.30232525, 9.63720894, 6.30232525 }
        },
        {
        {6.19302320, 9.33255768, 10.50465202, 11.67674446, 12.84883881, 14.02093220, 15.19302559, 16.36511612, 17.53720856, 12.23023319 },
        {9.73953533, 14.84651279, 16.54185867, 18.23720551, 19.93255806, 21.62790489, 23.32325554, 25.01860237, 26.71395111, 18.43255806 },
        {12.02790833, 18.23720551, 19.93255806, 21.62790489, 23.32325554, 25.01860237, 26.71395111, 28.40929985, 30.10464859, 20.66511726 },
        {14.31627941, 21.62790489, 23.32325554, 25.01860237, 26.71395111, 28.40929985, 30.10464859, 31.79999924, 33.49534988, 22.89767456 },
        {16.60465050, 25.01860237, 26.71395111, 28.40929985, 30.10464859, 31.79999924, 33.49534988, 35.19069290, 36.88604736, 25.13023376 },
        {18.89302063, 28.40929985, 30.10464859, 31.79999924, 33.49534988, 35.19069290, 36.88604736, 38.58139420, 40.27674103, 27.36278915 },
        {21.18139076, 31.79999924, 33.49534988, 35.19069290, 36.88604736, 38.58139420, 40.27674103, 41.97209167, 43.66744232, 29.59534836 },
        {23.46976471, 35.19069290, 36.88604736, 38.58139420, 40.27674103, 41.97209167, 43.66744232, 45.36279297, 47.05813980, 31.82790756 },
        {25.75813866, 38.58139420, 40.27674103, 41.97209167, 43.66744232, 45.36279297, 47.05813980, 48.75348663, 50.44883347, 34.06046677 },
        {17.53255844, 26.07674217, 27.16511536, 28.25348854, 29.34185982, 30.43023109, 31.51860237, 32.60697556, 33.69534683, 22.82558060 }
        },
        {
        {9.76046371, 15.16046524, 17.08604622, 19.01162529, 20.93720818, 22.86279106, 24.78837204, 26.71395302, 28.63953590, 19.81628036 },
        {15.94418526, 24.81860352, 27.64418602, 30.46976852, 33.29535294, 36.12093353, 38.94651031, 41.77209091, 44.59767532, 30.66511917 },
        {19.73953438, 30.46976852, 33.29535294, 36.12093353, 38.94651031, 41.77209091, 44.59767532, 47.42325974, 50.24884033, 34.40465164 },
        {23.53488541, 36.12093353, 38.94651031, 41.77209091, 44.59767532, 47.42325974, 50.24884033, 53.07442474, 55.90000534, 38.14418411 },
        {27.33023453, 41.77209091, 44.59767532, 47.42325974, 50.24884033, 53.07442474, 55.90000534, 58.72558212, 61.55116272, 41.88372040 },
        {31.12558174, 47.42325974, 50.24884033, 53.07442474, 55.90000534, 58.72558212, 61.55116272, 64.37673950, 67.20232391, 45.62325668 },
        {34.92093277, 53.07442474, 55.90000534, 58.72558212, 61.55116272, 64.37673950, 67.20232391, 70.02790833, 72.85348511, 49.36278915 },
        {38.71628189, 58.72558212, 61.55116272, 64.37673950, 67.20232391, 70.02790833, 72.85348511, 75.67907715, 78.50465393, 53.10232544 },
        {42.51162720, 64.37673950, 67.20232391, 70.02790833, 72.85348511, 75.67907715, 78.50465393, 81.33024597, 84.15581512, 56.84186172 },
        {29.13720894, 43.96046448, 45.80232239, 47.64418793, 49.48604965, 51.32790756, 53.16976547, 55.01163101, 56.85348892, 38.44883728 }
        },
        {
        {13.32790661, 20.98837280, 23.66744041, 26.34651184, 29.02558136, 31.70465469, 34.38372421, 37.06278992, 39.74185944, 27.40232658 },
        {22.14883804, 34.79069901, 38.74651337, 42.70232391, 46.65813828, 50.61394882, 54.56976700, 58.52558517, 62.48139954, 42.89767075 },
        {27.45116234, 42.70232391, 46.65813828, 50.61394882, 54.56976700, 58.52558517, 62.48139954, 66.43721008, 70.39302063, 48.14418793 },
        {32.75348663, 50.61394882, 54.56976700, 58.52558517, 62.48139954, 66.43721008, 70.39302063, 74.34883881, 78.30465698, 53.39069748 },
        {38.05581284, 58.52558517, 62.48139954, 66.43721008, 70.39302063, 74.34883881, 78.30465698, 82.26046753, 86.21627808, 58.63721085 },
        {43.35813904, 66.43721008, 70.39302063, 74.34883881, 78.30465698, 82.26046753, 86.21627808, 90.17208862, 94.12791443, 63.88372421 },
        {48.66046524, 74.34883881, 78.30465698, 82.26046753, 86.21627808, 90.17208862, 94.12791443, 98.08371735, 102.03953552, 69.13023376 },
        {53.96279144, 82.26046753, 86.21627808, 90.17208862, 94.12791443, 98.08371735, 102.03953552, 105.99533844, 109.95115662, 74.37674713 },
        {59.26511765, 90.17208862, 94.12791443, 98.08371735, 102.03953552, 105.99533844, 109.95115662, 113.90697479, 117.86277771, 79.62326050 },
        {40.74185944, 61.84418488, 64.43953705, 67.03488159, 69.63022614, 72.22557831, 74.82092285, 77.41628265, 80.01161957, 54.07209778 }
        }
    },
    {
        {
        {-20.02791023, -31.68837357, -34.28372192, -36.87907028, -39.47442245, -42.06976700, -44.66511154, -47.26046753, -49.85581207, -34.15814209 },
        {-33.27674484, -52.33720398, -56.29302216, -60.24884033, -64.20465088, -68.16046143, -72.11627960, -76.07209778, -80.02790070, -54.83488083 },
        {-38.52325821, -60.24884033, -64.20465088, -68.16046143, -72.11627960, -76.07209778, -80.02790070, -83.98372650, -87.93953705, -60.13721085 },
        {-43.76976395, -68.16046143, -72.11627960, -76.07209778, -80.02790070, -83.98372650, -87.93953705, -91.89534760, -95.85116577, -65.43952942 },
        {-49.01627731, -76.07209778, -80.02790070, -83.98372650, -87.93953705, -91.89534760, -95.85116577, -99.80698395, -103.76279449, -70.74185944 },
        {-54.26279068, -83.98372650, -87.93953705, -91.89534760, -95.85116577, -99.80698395, -103.76279449, -107.71861267, -111.67441559, -76.04418182 },
        {-59.50930023, -91.89534760, -95.85116577, -99.80698395, -103.76279449, -107.71861267, -111.67441559, -115.63023376, -119.58605194, -81.34651184 },
        {-64.75580597, -99.80698395, -103.76279449, -107.71861267, -111.67441559, -115.63023376, -119.58605194, -123.54186249, -127.49768829, -86.64883423 },
        {-70.00231934, -107.71861267, -111.67441559, -115.63023376, -119.58605194, -123.54186249, -127.49768829, -131.45349121, -135.40931702, -91.95116425 },
        {-49.09767532, -75.55813599, -78.23720551, -80.91627502, -83.59535217, -86.27441406, -88.95348358, -91.63255310, -94.31162262, -63.97208786 }
        },
        {
        {-14.45116329, -22.84651184, -24.68837166, -26.53023148, -28.37209320, -30.21395302, -32.05581284, -33.89767075, -35.73953247, -24.56278992 },
        {-24.05813980, -37.84418106, -40.66976547, -43.49534607, -46.32092667, -49.14651489, -51.97209549, -54.79767227, -57.62325668, -39.58837128 },
        {-27.79767418, -43.49534607, -46.32092667, -49.14651489, -51.97209549, -54.79767227, -57.62325668, -60.44883728, -63.27442169, -43.38372040 },
        {-31.53721046, -49.14651489, -51.97209549, -54.79767227, -57.62325668, -60.44883728, -63.27442169, -66.10000610, -68.92557526, -47.17907333 },
        {-35.27674103, -54.79767227, -57.62325668, -60.44883728, -63.27442169, -66.10000610, -68.92557526, -71.75115967, -74.57673645, -50.97442245 },
        {-39.01628113, -60.44883728, -63.27442169, -66.10000610, -68.92557526, -71.75115967, -74.57673645, -77.40231323, -80.22789764, -54.76977158 },
        {-42.75581741, -66.10000610, -68.92557526, -71.75115967, -74.57673645, -77.40231323, -80.22789764, -83.05348206, -85.87907410, -58.56511688 },
        {-46.49534607, -71.75115967, -74.57673645, -77.40231323, -80.22789764, -83.05348206, -85.87907410, -88.70465088, -91.53023529, -62.36046982 },
        {-50.23487854, -77.40231323, -80.22789764, -83.05348206, -85.87907410, -88.70465088, -91.53023529, -94.35581970, -97.18139648, -66.15581512 },
        {-35.48371887, -54.66046524, -56.58604813, -58.51162720, -60.43720627, -62.36279297, -64.28836823, -66.21395111, -68.13953400, -46.33953476 }
        },
        {
        {-8.37441826, -13.50465012, -14.59302235, -15.68139458, -16.76976585, -17.85813904, -18.94650841, -20.03488350, -21.12325478, -14.46744061 },
        {-14.33953381, -22.85116386, -24.54651260, -26.24185944, -27.93721008, -29.63256073, -31.32790756, -33.02325821, -34.71860504, -23.84186363 },
        {-16.57209206, -26.24185944, -27.93721008, -29.63256073, -31.32790756, -33.02325821, -34.71860504, -36.41395187, -38.10930252, -26.13023186 },
        {-18.80464935, -29.63256073, -31.32790756, -33.02325821, -34.71860504, -36.41395187, -38.10930252, -39.80464554, -41.50000000, -28.41860580 },
        {-21.03720856, -33.02325821, -34.71860504, -36.41395187, -38.10930252, -39.80464554, -41.50000000, -43.19534683, -44.89069366, -30.70697594 },
        {-23.26976776, -36.41395187, -38.10930252, -39.80464554, -41.50000000, -43.19534683, -44.89069366, -46.58604431, -48.28139877, -32.99534607 },
        {-25.50232887, -39.80464554, -41.50000000, -43.19534683, -44.89069366, -46.58604431, -48.28139877, -49.97674561, -51.67209625, -35.28371811 },
        {-27.73488808, -43.19534683, -44.89069366, -46.58604431, -48.28139877, -49.97674561, -51.67209625, -53.36744308, -55.06279373, -37.57209015 },
        {-29.96744537, -46.58604431, -48.28139877, -49.97674561, -51.67209625, -53.36744308, -55.06279373, -56.75814438, -58.45349121, -39.86046219 },
        {-21.36977005, -33.26279068, -34.43488312, -35.60697937, -36.77907181, -37.95116806, -39.12325668, -40.29534912, -41.46744156, -28.20697594 }
        },
        {
        {-2.59767437, -4.46279097, -4.79767466, -5.13255787, -5.46744204, -5.80232573, -6.13720894, -6.47209263, -6.80697680, -4.67209291 },
        {-4.92092991, -8.15813923, -8.72325611, -9.28837299, -9.85348988, -10.41860676, -10.98372269, -11.54883957, -12.11395359, -8.39534950 },
        {-5.64651155, -9.28837299, -9.85348988, -10.41860676, -10.98372269, -11.54883957, -12.11395359, -12.67907238, -13.24418736, -9.17674541 },
        {-6.37209320, -10.41860676, -10.98372269, -11.54883957, -12.11395359, -12.67907238, -13.24418736, -13.80930328, -14.37442112, -9.95813942 },
        {-7.09767485, -11.54883957, -12.11395359, -12.67907238, -13.24418736, -13.80930328, -14.37442112, -14.93953514, -15.50465393, -10.73953533 },
        {-7.82325649, -12.67907238, -13.24418736, -13.80930328, -14.37442112, -14.93953514, -15.50465393, -16.06976891, -16.63488388, -11.52093029 },
        {-8.54883862, -13.80930328, -14.37442112, -14.93953514, -15.50465393, -16.06976891, -16.63488388, -17.20000076, -17.76511765, -12.30232525 },
        {-9.27441978, -14.93953514, -15.50465393, -16.06976891, -16.63488388, -17.20000076, -17.76511765, -18.33023453, -18.89534950, -13.08372116 },
        {-10.00000191, -16.06976891, -16.63488388, -17.20000076, -17.76511765, -18.33023453, -18.89534950, -19.46046448, -20.02558327, -13.86511612 },
        {-7.55581379, -12.16511631, -12.58372116, -13.00232601, -13.42092991, -13.83953381, -14.25813961, -14.67674446, -15.09534836, -10.37441730 }
        },
        {
        {2.87906957, 4.27906990, 4.69767427, 5.11627913, 5.53488398, 5.95348835, 6.37209320, 6.79069757, 7.20930195, 4.82325602 },
        {4.19767427, 6.23488379, 6.80000019, 7.36511612, 7.93023252, 8.49534798, 9.06046486, 9.62558079, 10.19069767, 6.75116301 },
        {4.97906971, 7.36511612, 7.93023252, 8.49534798, 9.06046486, 9.62558079, 10.19069767, 10.75581455, 11.32093048, 7.47674417 },
        {5.76046467, 8.49534798, 9.06046486, 9.62558079, 10.19069767, 10.75581455, 11.32093048, 11.88604641, 12.45116234, 8.20232582 },
        {6.54186058, 9.62558079, 10.19069767, 10.75581455, 11.32093048, 11.88604641, 12.45116234, 13.01627922, 13.58139515, 8.92790699 },
        {7.32325554, 10.75581455, 11.32093048, 11.88604641, 12.45116234, 13.01627922, 13.58139515, 14.14651108, 14.71162796, 9.65348816 },
        {8.10465145, 11.88604641, 12.45116234, 13.01627922, 13.58139515, 14.14651108, 14.71162796, 15.27674389, 15.84186077, 10.37906933 },
        {8.88604641, 13.01627922, 13.58139515, 14.14651108, 14.71162796, 15.27674389, 15.84186077, 16.40697670, 16.97209358, 11.10465050 },
        {9.66744232, 14.14651108, 14.71162796, 15.27674389, 15.84186077, 16.40697670, 16.97209358, 17.53721046, 18.10232735, 11.83023167 },
        {5.95813942, 8.63255787, 8.96744156, 9.30232525, 9.63720894, 9.97209263, 10.30697727, 10.64186001, 10.97674370, 7.15813923 }
        },
        {
        {9.35581398, 14.02093220, 15.19302559, 16.36511612, 17.53720856, 18.70930290, 19.88139343, 21.05348778, 22.22558022, 15.31860447 },
        {14.31627941, 21.62790489, 23.32325554, 25.01860237, 26.71395111, 28.40929985, 30.10464859, 31.79999924, 33.49534988, 22.89767456 },
        {16.60465050, 25.01860237, 26.71395111, 28.40929985, 30.10464859, 31.79999924, 33.49534988, 35.19069290, 36.88604736, 25.13023376 },
        {18.89302063, 28.40929985, 30.10464859, 31.79999924, 33.49534988, 35.19069290, 36.88604736, 38.58139420, 40.27674103, 27.36278915 },
        {21.18139076, 31.79999924, 33.49534988, 35.19069290, 36.88604736, 38.58139420, 40.27674103, 41.97209167, 43.66744232, 29.59534836 },
        {23.46976471, 35.19069290, 36.88604736, 38.58139420, 40.27674103, 41.97209167, 43.66744232, 45.36279297, 47.05813980, 31.82790756 },
        {25.75813866, 38.58139420, 40.27674103, 41.97209167, 43.66744232, 45.36279297, 47.05813980, 48.75348663, 50.44883347, 34.06046677 },
        {28.04651260, 41.97209167, 43.66744232, 45.36279297, 47.05813980, 48.75348663, 50.44883347, 52.14418411, 53.83953094, 36.29302216 },
        {30.33488274, 45.36279297, 47.05813980, 48.75348663, 50.44883347, 52.14418411, 53.83953094, 55.53488159, 57.23022842, 38.52558517 },
        {20.47209358, 30.43023109, 31.51860237, 32.60697556, 33.69534683, 34.78371811, 35.87208939, 36.96046448, 38.04883575, 25.69069672 }
        },
        {
        {14.93255711, 22.86279106, 24.78837204, 26.71395302, 28.63953590, 30.56511688, 32.49069977, 34.41628265, 36.34186554, 24.91395378 },
        {23.53488541, 36.12093353, 38.94651031, 41.77209091, 44.59767532, 47.42325974, 50.24884033, 53.07442474, 55.90000534, 38.14418411 },
        {27.33023453, 41.77209091, 44.59767532, 47.42325974, 50.24884033, 53.07442474, 55.90000534, 58.72558212, 61.55116272, 41.88372040 },
        {31.12558174, 47.42325974, 50.24884033, 53.07442474, 55.90000534, 58.72558212, 61.55116272, 64.37673950, 67.20232391, 45.62325668 },
        {34.92093277, 53.07442474, 55.90000534, 58.72558212, 61.55116272, 64.37673950, 67.20232391, 70.02790833, 72.85348511, 49.36278915 },
        {38.71628189, 58.72558212, 61.55116272, 64.37673950, 67.20232391, 70.02790833, 72.85348511, 75.67907715, 78.50465393, 53.10232544 },
        {42.51162720, 64.37673950, 67.20232391, 70.02790833, 72.85348511, 75.67907715, 78.50465393, 81.33024597, 84.15581512, 56.84186172 },
        {46.30697250, 70.02790833, 72.85348511, 75.67907715, 78.50465393, 81.33024597, 84.15581512, 86.98139954, 89.80698395, 60.58139420 },
        {50.10232544, 75.67907715, 78.50465393, 81.33024597, 84.15581512, 86.98139954, 89.80698395, 92.63256073, 95.45815277, 64.32093048 },
        {34.08604813, 51.32790756, 53.16976547, 55.01163101, 56.85348892, 58.69534683, 60.53721237, 62.37907028, 64.22093201, 43.32325363 }
        },
        {
        {20.50930214, 31.70465469, 34.38372421, 37.06278992, 39.74185944, 42.42092896, 45.10000229, 47.77906799, 50.45814133, 34.50930405 },
        {32.75348663, 50.61394882, 54.56976700, 58.52558517, 62.48139954, 66.43721008, 70.39302063, 74.34883881, 78.30465698, 53.39069748 },
        {38.05581284, 58.52558517, 62.48139954, 66.43721008, 70.39302063, 74.34883881, 78.30465698, 82.26046753, 86.21627808, 58.63721085 },
        {43.35813904, 66.43721008, 70.39302063, 74.34883881, 78.30465698, 82.26046753, 86.21627808, 90.17208862, 94.12791443, 63.88372421 },
        {48.66046524, 74.34883881, 78.30465698, 82.26046753, 86.21627808, 90.17208862, 94.12791443, 98.08371735, 102.03953552, 69.13023376 },
        {53.96279144, 82.26046753, 86.21627808, 90.17208862, 94.12791443, 98.08371735, 102.03953552, 105.99533844, 109.95115662, 74.37674713 },
        {59.26511765, 90.17208862, 94.12791443, 98.08371735, 102.03953552, 105.99533844, 109.95115662, 113.90697479, 117.86277771, 79.62326050 },
        {64.56744385, 98.08371735, 102.03953552, 105.99533844, 109.95115662, 113.90697479, 117.86277771, 121.81860352, 125.77441406, 84.86976624 },
        {69.86976624, 105.99533844, 109.95115662, 113.90697479, 117.86277771, 121.81860352, 125.77441406, 129.73022461, 133.68603516, 90.11627197 },
        {47.69999695, 72.22557831, 74.82092285, 77.41628265, 80.01161957, 82.60697174, 85.20231628, 87.79766846, 90.39302063, 60.95581436 }
        }
    }
    });

    auto convolution = ConvLayer(3, 8, 3);
    convolution.setBias(bias);
    convolution.setWeights(weights);

    Tensor<float, 4> output = convolution.forward(input);

    for (int b = 0; b < batches; b++) {
        for (int oc = 0; oc < out_channels; oc++) {
            for (int h = 0; h < expectedOutput.dimension(2); h++) {
                for (int w  = 0; w < expectedOutput.dimension(3); w++) {
                    REQUIRE(approx_equal(output(b, oc, h, w), expectedOutput(b, oc, h, w)));
                }
            }
        }
    }

}